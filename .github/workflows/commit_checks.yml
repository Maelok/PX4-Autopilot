name: Commit Quality

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PR_NUMBER: ${{ github.event.pull_request.number }}

jobs:
  pr-title:
    name: PR Title
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: Tools/ci
          depth: 1

      - name: Check PR title
        id: check
        run: |
          output=$(python3 Tools/ci/check_pr_title.py "${{ github.event.pull_request.title }}" 2>&1) && rc=0 || rc=$?
          echo "$output"
          {
            echo "output<<COMMIT_CHECK_EOF"
            echo "$output"
            echo "COMMIT_CHECK_EOF"
          } >> "$GITHUB_OUTPUT"
          echo "exit_code=$rc" >> "$GITHUB_OUTPUT"

      - name: Post or clear comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ steps.check.outputs.exit_code }}" != "0" ]; then
            printf '%s\n' \
              "## PR Title" \
              "" \
              "The PR title does not follow the required format." \
              "" \
              '```' \
              "${{ steps.check.outputs.output }}" \
              '```' \
              "" \
              "Please update your PR title to use the \`subsystem: description\` format." \
            | python3 Tools/ci/pr_comment.py --marker pr-title --pr "$PR_NUMBER" --result fail
          else
            python3 Tools/ci/pr_comment.py --marker pr-title --pr "$PR_NUMBER" --result pass
          fi

      - name: Fail if title is bad
        if: steps.check.outputs.exit_code != '0'
        run: exit 1

  commit-messages:
    name: Commit Messages
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: Tools/ci
          depth: 1

      - name: Check commit messages
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          output=$(gh api \
            "repos/${{ github.repository }}/pulls/${PR_NUMBER}/commits?per_page=100" \
            | python3 Tools/ci/check_commit_messages.py 2>&1) && rc=0 || rc=$?
          echo "$output"
          {
            echo "output<<COMMIT_CHECK_EOF"
            echo "$output"
            echo "COMMIT_CHECK_EOF"
          } >> "$GITHUB_OUTPUT"
          echo "exit_code=$rc" >> "$GITHUB_OUTPUT"

      - name: Post or clear comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          rc="${{ steps.check.outputs.exit_code }}"
          output="${{ steps.check.outputs.output }}"

          if [ "$rc" != "0" ]; then
            printf '%s\n' \
              "## Commit Messages" \
              "" \
              "Some commit messages in this PR do not meet the project requirements and **must be fixed before merging**." \
              "" \
              '```' \
              "$output" \
              '```' \
            | python3 Tools/ci/pr_comment.py --marker commit-msgs --pr "$PR_NUMBER" --result fail
          elif [ -n "$output" ]; then
            printf '%s\n' \
              "## Commit Messages (advisory)" \
              "" \
              "This is **not blocking**, but we noticed some commit messages that could be improved." \
              "" \
              '```' \
              "$output" \
              '```' \
              "" \
              "**Why this matters:** every commit that lands on \`main\` becomes permanent project history." \
              "Clean, prefixed messages (\`subsystem: description\`) make \`git log\`, \`git blame\`," \
              "and release notes much more useful." \
              "" \
              "Squashing review-response and formatting commits into their parent keeps the history focused on meaningful changes." \
            | python3 Tools/ci/pr_comment.py --marker commit-msgs --pr "$PR_NUMBER" --result warn
          else
            python3 Tools/ci/pr_comment.py --marker commit-msgs --pr "$PR_NUMBER" --result pass
          fi

      - name: Fail if blocking errors
        if: steps.check.outputs.exit_code != '0'
        run: exit 1

  pr-body:
    name: PR Description
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: Tools/ci
          depth: 1

      - name: Check PR body
        id: check
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          message=""
          if [ -z "$PR_BODY" ]; then
            message="PR description is empty. Please add a summary of the changes."
            echo "::warning::PR description is empty."
          else
            cleaned=$(echo "$PR_BODY" | sed 's/<!--.*-->//g' | tr -d '[:space:]')
            if [ -z "$cleaned" ]; then
              message="PR description contains only template comments. Please fill in the details."
              echo "::warning::PR description contains only template comments."
            fi
          fi
          echo "message=$message" >> "$GITHUB_OUTPUT"

      - name: Post or clear comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          message="${{ steps.check.outputs.message }}"

          if [ -n "$message" ]; then
            printf '%s\n' \
              "## PR Description (advisory)" \
              "" \
              "This is **not blocking**, but your PR description appears to be empty or incomplete." \
              "" \
              "$message" \
              "" \
              "A good PR description helps reviewers understand what changed and why." \
            | python3 Tools/ci/pr_comment.py --marker pr-body --pr "$PR_NUMBER" --result warn
          else
            python3 Tools/ci/pr_comment.py --marker pr-body --pr "$PR_NUMBER" --result pass
          fi
